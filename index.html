<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Isekai Foundry â€” OOP Single-File</title>
<meta name="theme-color" content="#0b0d10" />
<style>
:root{
  --bg:#0b0d10; --text:#eaf2ff; --muted:#9ab0c9; --card:#0f141b;
  --line:#1e2735; --accent:#88e0ff; --accent2:#b592ff; --ok:#7cf58a; --warn:#ffd166; --danger:#ff6b6b;
}
:root[data-theme="light"]{
  --bg:#f6f8fc; --text:#0c1016; --muted:#536277; --card:#ffffff; --line:#dee6f3; --accent:#0066cc; --accent2:#7a3cff; --ok:#0a7a44; --warn:#ad6a00; --danger:#b80d2e;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
#app{max-width:920px;margin:0 auto;padding:14px}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.card{background:linear-gradient(180deg,var(--card),color-mix(in srgb,var(--card) 90%, #000 10%));border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 22px rgba(0,0,0,.25)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
.btn{background:color-mix(in srgb,var(--card) 88%, #000 12%);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:filter .15s ease}
.btn:hover{filter:brightness(1.08)}
.btn.primary{background:linear-gradient(180deg,color-mix(in srgb,var(--accent) 16%, #000 84%), color-mix(in srgb,var(--accent) 6%, #000 94%));border-color:color-mix(in srgb,var(--accent) 40%, var(--line) 60%);color:#fff}
.btn.ghost{background:transparent;border:1px dashed var(--line)}
.btn.ok{background:linear-gradient(180deg,color-mix(in srgb,var(--ok) 18%, #000 82%), color-mix(in srgb,var(--ok) 6%, #000 94%));border-color:color-mix(in srgb,var(--ok) 40%, var(--line) 60%);color:#fff}
.btn.warn{background:linear-gradient(180deg,color-mix(in srgb,var(--warn) 18%, #000 82%), color-mix(in srgb,var(--warn) 6%, #000 94%));border-color:color-mix(in srgb,var(--warn) 40%, var(--line) 60%);color:#fff}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{background:color-mix(in srgb,var(--card) 88%, #000 12%);border:1px solid var(--line);border-radius:999px;padding:6px 10px;display:flex;gap:6px;align-items:center;color:var(--muted)}
.pill b{color:var(--text)}
.tabs{display:flex;gap:8px;margin:10px 0}
.tabbtn{flex:1;border:1px solid var(--line);background:color-mix(in srgb,var(--card) 90%, #000 10%);color:var(--text);border-radius:12px;padding:10px 8px;cursor:pointer}
.tabbtn[aria-selected="true"]{background:linear-gradient(180deg,color-mix(in srgb,var(--accent2) 8%, #000 92%), color-mix(in srgb,var(--accent2) 4%, #000 96%));border-color:color-mix(in srgb,var(--accent2) 40%, var(--line) 60%);color:#fff;box-shadow:0 4px 16px color-mix(in srgb,var(--accent2) 20%, #000 80%)}
.section{display:none}
.section.active{display:block;animation:fade .15s ease}
@keyframes fade{from{opacity:.5;transform:translateY(2px)}to{opacity:1;transform:none}}
.kv{display:flex;gap:12px;align-items:center}
.kv svg{width:120px;height:120px;border-radius:12px;background:color-mix(in srgb,var(--card) 85%, #000 15%);border:1px solid var(--line)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:6px 8px;text-align:left}
.hint{color:var(--muted);font-size:12px}
.badge{font-size:12px;border:1px solid var(--line);background:color-mix(in srgb,var(--card) 92%, #000 8%);color:var(--text);border-radius:999px;padding:2px 8px}
.rarity{font-weight:700}
.rS{color:#ffd38a}.rA{color:#9bd0ff}.rB{color:#b7ffa7}
.statbar{height:8px;background:color-mix(in srgb,var(--card) 85%, #000 15%);border:1px solid var(--line);border-radius:999px;overflow:hidden}
.statbar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:color-mix(in srgb,var(--card) 90%, #000 10%);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s, transform .2s}
.toast.show{opacity:1;transform:translate(-50%,-4px)}
.canvasWrap{background:color-mix(in srgb,var(--card) 85%, #000 15%);border:1px solid var(--line);border-radius:12px;padding:8px}
.copybox{display:flex;gap:8px}.copybox input{flex:1}
#summaryCvs{max-width:100%}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:8px 0 10px}
kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:color-mix(in srgb,var(--card) 88%, #000 12%);border:1px solid var(--line);border-radius:6px;padding:0 6px}
</style>
</head>
<body>
<div id="app" role="application" aria-label="Isekai Foundry (OOP)">
  <div class="topbar">
    <div class="pills">
      <span class="pill">ğŸ—ï¸ Seed: <b id="seedLbl">-</b></span>
      <span class="pill">â­ Legend: <b id="legendLbl">0</b></span>
      <span class="pill">ğŸ§­ Mode: <b id="modeLbl">Casual</b></span>
      <span class="pill">ğŸ§ Sound: <b id="soundLbl">Off</b></span>
      <span class="pill">ğŸ¨ Theme: <b id="themeLbl">Dark</b></span>
    </div>
    <div class="row">
      <button class="btn ghost" id="btnTheme">åˆ‡æ›¿</button>
      <button class="btn ghost" id="btnSound">éŸ³ON/OFF</button>
      <button class="btn ghost" id="btnCasual">Casual</button>
      <button class="btn ghost" id="btnDaily">Daily</button>
      <button class="btn" id="btnReset">Reset</button>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <button class="tabbtn" aria-selected="true"  data-tab="input">å…¥åŠ›</button>
    <button class="tabbtn" aria-selected="false" data-tab="bestow">æˆä¸</button>
    <button class="tabbtn" aria-selected="false" data-tab="choose">é¸æŠ</button>
    <button class="tabbtn" aria-selected="false" data-tab="prologue">åºç« </button>
    <button class="tabbtn" aria-selected="false" data-tab="result">çµæœ/å…±æœ‰</button>
    <button class="tabbtn" aria-selected="false" data-tab="codex">å›³é‘‘</button>
    <button class="tabbtn" aria-selected="false" data-tab="packs">Pack</button>
    <button class="tabbtn" aria-selected="false" data-tab="settings">è¨­å®š</button>
  </div>

  <!-- INPUT -->
  <section class="section active" id="sec-input">
    <div class="card">
      <h2>å‰ä¸–å…¥åŠ›</h2>
      <div class="grid cols-2">
        <div><label>åå‰</label><input class="input" id="inName" placeholder="ä¾‹: æ–è—¤ãƒ¦ã‚¦" /></div>
        <div><label>æ€§åˆ¥</label><select id="inGender" class="input"><option>ä¸å•</option><option>ç”·æ€§</option><option>å¥³æ€§</option><option>ãã®ä»–</option></select></div>
        <div><label>å¹´é½¢</label><input class="input" id="inAge" type="number" min="10" max="120" placeholder="29" /></div>
        <div><label>è·æ¥­</label><input class="input" id="inJob" placeholder="ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢" /></div>
        <div class="grid cols-2" style="grid-column:1/-1">
          <div><label>æ­»å› ï¼ˆç©å½“è¡¨ç¾ï¼‰</label><input class="input" id="inDeath" placeholder="äº‹æ•…/ç—…/éåŠ´" /></div>
          <div><label>å¤¢ï¼ˆç›®æ¨™ï¼‰</label><input class="input" id="inDream" placeholder="ä¾‹: ä¸–ç•Œã‚’æ—…ã™ã‚‹" /></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnRand">ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button class="btn primary" id="btnMake">ç”Ÿæˆ</button>
        <span class="hint">â€»å…¥åŠ›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã€‚å¤–éƒ¨é€ä¿¡ãªã—</span>
      </div>
    </div>
    <hr>
    <div class="card">
      <h2>ãƒ¢ãƒ¼ãƒ‰ã¨ã‚·ãƒ¼ãƒ‰</h2>
      <div class="hint">Dailyã¯ <kbd>?seed=YYYYMMDD</kbd> å›ºå®šãƒ»æ•°å€¤è£œæ­£ã¯ç„¡åŠ¹ï¼ˆå¯è¦–ã®ã¿ï¼‰/ Casual ã¯è‡ªç”±ã€‚</div>
    </div>
  </section>

  <!-- BESTOWAL -->
  <section class="section" id="sec-bestow">
    <div class="card">
      <div class="kv">
        <svg id="avatar" viewBox="0 0 120 120" aria-label="Avatar"></svg>
        <div style="flex:1">
          <h2 id="worldName">ç•°ä¸–ç•Œå</h2>
          <div class="row"><span class="badge" id="worldTags"></span><span class="badge" id="startSpot"></span></div>
          <table class="table" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"><tbody id="statTbody"></tbody></table>
        </div>
      </div>
      <hr>
      <h3>å¥³ç¥ã®æˆä¸ï¼ˆãƒãƒ¼ãƒˆå€™è£œ Ã—3ï¼‰</h3>
      <div id="cheatList" class="grid cols-3"></div>
      <div class="hint">â€»å¼·åŠ›ãªã»ã©ã€ŒFD(é‹å‘½å‚µ)ã€ãŒé«˜ããªã‚Šã¾ã™</div>
    </div>
  </section>

  <!-- CHOOSE -->
  <section class="section" id="sec-choose">
    <div class="card">
      <h2>é¸æŠï¼šãƒãƒ¼ãƒˆã‚’1ã¤é¸ã³ã€èª“ç´„ã§FDã‚’è»½æ¸›</h2>
      <div id="chosenCheat" class="row"></div>
      <h3>èª“ç´„ï¼ˆ1ã¤ï¼‰</h3>
      <div class="grid cols-3" id="vowList"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnLockIn" disabled>èª“ç´„ã—ã¦é€²ã‚€</button>
        <span class="hint">èª“ç´„ã¯å®ˆã‚‹ã»ã© FD ã‚’è»½æ¸›ï¼ˆä¸‹é™0ï¼‰</span>
      </div>
    </div>
  </section>

  <!-- PROLOGUE / EVENTS -->
  <section class="section" id="sec-prologue">
    <div class="card">
      <h2>ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°</h2>
      <p id="goddessLine" class="hint">å¥³ç¥ï¼šã€Œâ€¦â€¦ã‚ˆã†ã“ãã€æ–°ãŸãªæ—…è·¯ã¸ã€</p>
      <div id="encCard" class="card"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnNextTurn">æ¬¡ã¸</button>
        <span class="hint">å…¨3ã‚¿ãƒ¼ãƒ³ï¼‹<b>å®¿æ•µåˆ¤å®š</b>ã€‚æˆåŠŸ/å¤±æ•—ã§ä¼èª¬å€¤(Legend)ãŒå¢—æ¸›</span>
      </div>
    </div>
  </section>

  <!-- RESULT / SHARE -->
  <section class="section" id="sec-result">
    <div class="card">
      <h2>çµæœ / å…±æœ‰</h2>
      <div class="grid cols-2">
        <div class="canvasWrap"><canvas id="summaryCvs" width="600" height="800" aria-label="Summary image"></canvas></div>
        <div>
          <div id="resultText"></div>
          <hr>
          <div class="copybox"><input class="input" id="shareUrl" readonly /><button class="btn" id="btnCopy">URLã‚³ãƒ”ãƒ¼</button></div>
          <div class="row" style="margin-top:8px">
            <button class="btn ok" id="btnSavePng">ç”»åƒä¿å­˜</button>
            <button class="btn" id="btnReplay">ã‚‚ã†ä¸€åº¦</button>
            <button class="btn" id="btnWebShare">Web Share</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CODEX -->
  <section class="section" id="sec-codex">
    <div class="card">
      <h2>å›³é‘‘ / ã‚³ãƒ³ãƒ—ç‡</h2>
      <div class="row">
        <span class="pill">ç¥ç¦: <b id="codBless">0/0</b></span>
        <span class="pill">ç§°å·: <b id="codTitles">0/0</b></span>
        <span class="pill">é‚‚é€…: <b id="codEncounter">0/0</b></span>
        <span class="pill">åˆè¨ˆ: <b id="codTotal">0%</b></span>
      </div>
      <div id="codexList" class="grid cols-3" style="margin-top:10px"></div>
      <hr />
      <h3>ç« è§£æ”¾</h3>
      <div id="storyList" class="grid cols-2"></div>
    </div>
  </section>

  <!-- PACKS -->
  <section class="section" id="sec-packs">
    <div class="card">
      <h2>World Packï¼ˆRemixï¼‰</h2>
      <p class="hint">JSONè²¼ä»˜ã§ä¸–ç•Œè¦³/ãƒãƒ¼ãƒˆ/é­é‡ã‚«ãƒ¼ãƒ‰ã‚’å·®ã—æ›¿ãˆã€‚ç ´ææ™‚ã¯é©ç”¨ã—ã¾ã›ã‚“ã€‚</p>
      <textarea id="packJson" class="input" rows="10" placeholder='{"packId":"high-fantasy-v1", ... }'></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnApplyPack">é©ç”¨</button>
        <button class="btn ghost" id="btnLoadExample">ä¾‹ã‚’æŒ¿å…¥</button>
      </div>
      <hr />
      <div class="hint">URLèª­ã¿è¾¼ã¿: <kbd>?packUrl=</kbd> ã‚‚å¯¾å¿œ</div>
    </div>
  </section>

  <!-- SETTINGS (Save import/export, PWA) -->
  <section class="section" id="sec-settings">
    <div class="card">
      <h2>è¨­å®š / ä¿å­˜</h2>
      <div class="row">
        <button class="btn" id="btnExport">ã‚»ãƒ¼ãƒ–ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn">
          ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<input type="file" id="fileImport" accept="application/json" style="display:none" />
        </label>
        <button class="btn ghost" id="btnRegisterSW">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒ–ï¼ˆPWAï¼‰</button>
      </div>
      <div class="hint">GitHub Pagesç­‰ã®HTTPSç’°å¢ƒã§PWAç™»éŒ²ã§ãã¾ã™ã€‚file://ã§ã¯ä¸å¯ã€‚</div>
    </div>
  </section>
</div>
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/***********************
 *  åŸºç›¤ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 ***********************/
class Util{
  static $(s){return document.querySelector(s)}
  static $$(s){return Array.from(document.querySelectorAll(s))}
  static el(tag,attrs={},children=[]){
    const e=document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==='class') e.className=v; else if(k==='text') e.textContent=v; else if(k==='html') e.innerHTML=v;
      else if(k.startsWith('on')&&typeof v==='function') e.addEventListener(k.slice(2),v);
      else e.setAttribute(k,v);
    }
    for(const c of [].concat(children)) if(c) e.appendChild(c);
    return e;
  }
  static clamp(x,a,b){return Math.max(a,Math.min(b,x))}
  static hash32(str){ let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h)+str.charCodeAt(i); h|=0; } return h>>>0; }
  static todaySeed(){ const d=new Date(); const yyyy=d.getFullYear(); const mm=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2); return parseInt(`${yyyy}${mm}${dd}`,10); }
  static toast(msg,ms=1400){ const t=Util.$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms) }
}
class RNG{
  constructor(seed){ this.state=((seed>>>0)||1)>>>0; }
  next(){ this.state = (1664525*this.state + 1013904223)>>>0; return this.state/4294967296; }
  range(a,b){ return a + Math.floor(this.next()*(b-a+1)); }
  pick(arr){ return arr[(this.next()*arr.length)|0]; }
  chance(p){ return this.next()<p; }
}
class Sound{
  static enabled=false; static ctx=null;
  static toggle(){ this.enabled=!this.enabled; Util.$('#soundLbl').textContent=this.enabled?'On':'Off'; if(this.enabled && !this.ctx){ try{ this.ctx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} } }
  static beep(ok=true){ if(!this.enabled||!this.ctx) return; const ctx=this.ctx; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value= ok? 880: 220; g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.15); o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.16); }
}
class Theme{
  static current='dark';
  static load(){ const v=localStorage.getItem('if_theme'); if(v) this.current=v; document.documentElement.dataset.theme = this.current==='light'?'light':''; Util.$('#themeLbl').textContent=this.current==='light'?'Light':'Dark'; }
  static toggle(){ this.current = this.current==='light'?'dark':'light'; localStorage.setItem('if_theme', this.current); this.load(); }
}

/***********************
 *  ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
 ***********************/
class Profile{
  constructor({name,gender,age,job,death,dream}){ Object.assign(this,{name,gender,age,job,death,dream}); }
  static sanitizeDeath(s=''){
    const rules=[[/suicide|è‡ªæ®º|self-harm|ãƒªã‚¹ã‚«|è‡ªã€‡|é¦–|æ¯’|é£›ã³/i,'ä¸æ…®ã®äº‹æ•…'],[/murder|æ®ºäºº|åˆºæ®º|éŠƒ|æš´åŠ›æ­»/i,'äº‹æ•…'],[/illness|ç—…æ­»|é›£ç—…|ãŒã‚“|ç™Œ/i,'ç—…'],[/overwork|éåŠ´|ãƒ–ãƒ©ãƒƒã‚¯/i,'éåŠ´'],[/covid|ã‚³ãƒ­ãƒŠ/i,'ç—…'],[/unknown|ä¸æ˜/i,'äº‹æ•…']];
    for(const [re,rep] of rules){ if(re.test(s)) return rep; }
    s=s.trim(); if(!s) s='äº‹æ•…'; if(s.length>12) s=s.slice(0,12); return s;
  }
  static fromInputs(){ const $=Util.$; return new Profile({ name:$('#inName').value.trim()||'æ—…äºº', gender:$('#inGender').value, age:Math.max(10,Math.min(120,parseInt($('#inAge').value||'25'))), job:$('#inJob').value.trim()||'è‡ªç”±æ¥­', death:Profile.sanitizeDeath($('#inDeath').value), dream:($('#inDream').value||'é™ã‹ãªæš®ã‚‰ã—').trim().slice(0,40) }); }
  static randomizeToInputs(){ const $=Util.$; const names=['ãƒ¦ã‚¦ãƒˆ','ãƒŸãƒŠãƒˆ','ã‚¹ã‚º','ãƒãƒ«','ãƒ¬ãƒ³','ã‚¢ã‚ªã‚¤']; const jobs=['ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢','æ–™ç†äºº','æ•™å¸«','é…é”','å­¦ç”Ÿ','ã‚«ãƒ¡ãƒ©ãƒãƒ³']; $('#inName').value=names[(Math.random()*names.length)|0]; $('#inGender').value=['ä¸å•','ç”·æ€§','å¥³æ€§','ãã®ä»–'][(Math.random()*4)|0]; $('#inAge').value=18+((Math.random()*40)|0); $('#inJob').value=jobs[(Math.random()*jobs.length)|0]; $('#inDeath').value=['äº‹æ•…','ç—…','éåŠ´'][(Math.random()*3)|0]; $('#inDream').value=['ä¸–ç•Œã‚’æ—…ã™ã‚‹','é™ã‹ãªæš®ã‚‰ã—','æœ€é«˜ã®ç‰©èªã‚’æ›¸ã','ç¾å‘³ã—ã„åº—ã‚’å·¡ã‚‹'][(Math.random()*4)|0]; }
  seed(){ return Util.hash32(`${this.name}|${this.gender}|${this.age}|${this.job}|${this.death}|${this.dream}`); }
}
class Stats{
  constructor(map){ this.map=map }
  static generate(seed){ const rng=new RNG(seed); const base=[50,50,50,50,50]; let pool=rng.range(100,140); while(pool--) base[rng.range(0,4)]++; const m={STR:base[0],DEX:base[1],INT:base[2],CHA:base[3],LUCK:base[4]}; return new Stats(m); }
  get(k){return this.map[k]||50}
}
class World{
  constructor({name,tags,spot}){ Object.assign(this,{name,tags,spot}); }
  static build(seed, pack){ const rng=new RNG(seed); const pre=['ã‚¢ã‚¹','ã‚¨ãƒ«','ãƒªãƒ ','ãƒã‚¢','ãƒ´ã‚¡ãƒ«','ãƒŸãƒ«','ã‚»ãƒ©','ãƒ•ã‚£ãƒ³']; const suf=['ãƒªã‚¢','ã‚¬ãƒ«ãƒ‰','ãƒãƒ¼ãƒˆ','ãƒ‡ã‚£ã‚¢','ãƒã‚¤ãƒ ','ãƒ•ã‚©ãƒ«ãƒ‰','ã‚·ã‚¢']; const name=rng.pick(pre)+rng.pick(suf); const tags=rng.pick([['kingdom','guild'],['forest','dragon'],['desert','trade'],['snow','ruins']]); const spot=rng.pick(pack.startSpots||['ç‹éƒ½ãƒŸãƒ«ã‚¼','ã‚®ãƒ«ãƒ‰è¡—ãƒ¬ã‚¤ãƒ³','è¾ºå¢ƒã‚¨ãƒ«ãƒ‰æ—','æ¸¯æ¹¾ãƒŠã‚¤ãƒ«']); return new World({name,tags,spot}); }
}
class Avatar{
  static render(svg, seed){ const rng=new RNG(seed); const skin=`hsl(${rng.range(20,40)},30%,${rng.range(55,70)}%)`; const hair=`hsl(${rng.range(0,360)},45%,${rng.range(25,40)}%)`; const eye=`hsl(${rng.range(180,260)},70%,${rng.range(45,60)}%)`; const deco=`hsl(${rng.range(0,360)},70%,60%)`; const NS='http://www.w3.org/2000/svg'; const S=(t,a)=>{const e=document.createElementNS(NS,t); for(const k in a)e.setAttribute(k,a[k]); return e}; svg.innerHTML=''; svg.appendChild(S('rect',{x:0,y:0,width:120,height:120,rx:12,fill:'color-mix(in srgb,var(--card) 85%, #000 15%)'})); svg.appendChild(S('circle',{cx:60,cy:70,r:38,fill:skin})); svg.appendChild(S('ellipse',{cx:60,cy:40,rx:42,ry:28,fill:hair})); svg.appendChild(S('circle',{cx:46,cy:70,r:6,fill:eye})); svg.appendChild(S('circle',{cx:74,cy:70,r:6,fill:eye})); svg.appendChild(S('rect',{x:38,y:94,width:44,height:8,rx:4,fill:deco,opacity:.4})); }
}
class Cheat{ constructor(obj){Object.assign(this,obj)} }
class Vow{ constructor(obj){Object.assign(this,obj)} }
class Encounter{ constructor(obj){Object.assign(this,obj)} }

/***********************
 *  Pack ç®¡ç†
 ***********************/
class Pack{
  constructor(obj){ Object.assign(this, obj) }
  static default(){ return new Pack({
    packId:'foundry-default-v2', title:'High Fantasy / Guild',
    worldTags:['kingdom','guild','dragon','forest'], startSpots:['ç‹éƒ½ãƒŸãƒ«ã‚¼','ã‚®ãƒ«ãƒ‰è¡—ãƒ¬ã‚¤ãƒ³','è¾ºå¢ƒã‚¨ãƒ«ãƒ‰æ—','æ¸¯æ¹¾ãƒŠã‚¤ãƒ«'],
    goddessLines:['â€¦â€¦ã‚ˆã†ã“ãã€æ–°ãŸãªæ—…è·¯ã¸ã€‚','é­‚ã¯å·¡ã‚Šã€ç‰©èªã¯å†ã³ç¯ã‚‹ã€‚','é¸ã³ãªã•ã„ã€‚åŠ›ã‚‚ã€ç¸›ã‚Šã‚‚ã€ã™ã¹ã¦ã¯å›ã®æ„å¿—ã€‚'],
    cheats:[
      new Cheat({id:'chrono-needle',rank:'S',name:'æœªæ¥è¦–ã®ç§’é‡',fd:3,desc:'é¸æŠè‚¢ã®æˆåŠŸç‡ã‚’è–„ãå¯è¦–åŒ–',effect:{reveal:true}}),
      new Cheat({id:'omni-tongue',rank:'S',name:'ä¸‡ç‰©è¨€èª',fd:3,desc:'äº¤æ¸‰+20%',effect:{social:+0.20}}),
      new Cheat({id:'swift-evade',rank:'A',name:'è¿…é€Ÿå›é¿',fd:2,desc:'å±é™ºã‚¤ãƒ™ãƒ³ãƒˆã§ä¸€åº¦ã ã‘è‡ªå‹•å›é¿',effect:{autoevade:1}}),
      new Cheat({id:'spark-create',rank:'A',name:'å‰µé€ ã®ç«èŠ±',fd:2,desc:'ã‚¯ãƒ©ãƒ•ãƒˆåˆ¤å®š+15%ã€åˆæœŸè³‡æº+1',effect:{craft:+0.15,resource:+1}}),
      new Cheat({id:'lucky-feather',rank:'B',name:'å¹¸é‹ã®ç¾½æ ¹',fd:1,desc:'ãƒ¬ã‚¢ã‚¤ãƒ™ãƒ³ãƒˆ+5%',effect:{rare:+0.05}}),
      new Cheat({id:'shadow-step',rank:'B',name:'å½±æ¸¡ã‚Š',fd:1,desc:'å¥‡è¥²+10%',effect:{combat:+0.10}})
    ],
    encounters:[
      new Encounter({id:'e001',type:'Combat',title:'å¤æ£®ã®é­”ç‹¼',stat:'DEX',base:0.55,reward:8}),
      new Encounter({id:'e002',type:'Social',title:'ç‹éƒ½ã®è¨±å¯è¨¼',stat:'CHA',base:0.50,reward:6}),
      new Encounter({id:'e003',type:'Explore',title:'åœ°ä¸‹æ°´è·¯ã®åœ°å›³',stat:'INT',base:0.52,reward:7}),
      new Encounter({id:'e004',type:'Combat',title:'ç«œã®é±—ã®ç›—è³Š',stat:'STR',base:0.48,reward:9}),
      new Encounter({id:'e005',type:'Social',title:'ã‚®ãƒ«ãƒ‰äº¤æ¸‰',stat:'CHA',base:0.53,reward:7}),
      new Encounter({id:'e006',type:'Explore',title:'å¤ä»£ç¢‘æ–‡ã®è§£èª­',stat:'INT',base:0.54,reward:8})
    ],
    titles:[
      {id:'t_small_miracle', name:'å°ã•ãå¥‡è·¡', cond:(ctx)=>ctx.legend>=10},
      {id:'t_vowbound', name:'å¥‘ç´„ã®å°ã', cond:(ctx)=>ctx.vowKept>=2},
      {id:'t_fatebreaker', name:'é‹å‘½ç ´ã‚Š', cond:(ctx)=>ctx.fd<=1 && ctx.legend>=16},
      {id:'t_stargazer', name:'æ˜Ÿè¦‹ã®æ—…äºº', cond:(ctx)=>ctx.events.Explore>=2}
    ]
  }) }
}
class PackManager{
  constructor(){ this.active=Pack.default() }
  apply(obj){ // shallow merge + validation
    if(!obj||!obj.packId) throw new Error('packId missing');
    const base=Pack.default();
    for(const k of Object.keys(obj)){
      if(Array.isArray(obj[k])) base[k]=obj[k]; else if(typeof obj[k]==='object') base[k]=Object.assign({}, base[k]||{}, obj[k]); else base[k]=obj[k];
    }
    this.active=new Pack(base); Util.toast('Pack é©ç”¨: '+(this.active.title||this.active.packId));
  }
  async loadFromUrl(url){ const res=await fetch(url,{mode:'cors'}); if(!res.ok) throw new Error(res.status+' '+res.statusText); const obj=await res.json(); this.apply(obj); }
}

/***********************
 *  ã‚»ãƒ¼ãƒ–ç®¡ç†
 ***********************/
class Save{
  static key='isekai_foundry_oop_v1';
  static load(){ try{ const raw=localStorage.getItem(this.key); if(!raw) return null; const s=JSON.parse(raw); s.codex=s.codex||{}; s.codex.blessings=new Set(s.codex.blessings||[]); s.codex.titles=new Set(s.codex.titles||[]); s.codex.encounters=new Set(s.codex.encounters||[]); return s; }catch{ return null; } }
  static save(s){ const out=JSON.stringify({ profile:s.profile, seed:s.seed, stats:s.stats?.map||s.stats, world:s.world, chosenCheat:s.chosenCheat, vow:s.vow, fd:s.fd, legend:s.legend, vowKept:s.vowKept, codex:{ blessings:[...s.codex.blessings], titles:[...s.codex.titles], encounters:[...s.codex.encounters] } }); localStorage.setItem(this.key, out); }
  static reset(){ localStorage.removeItem(this.key); }
  static export(){ const blob=new Blob([localStorage.getItem(this.key)||'{}'],{type:'application/json'}); const a=document.createElement('a'); a.download='isekai_foundry_save.json'; a.href=URL.createObjectURL(blob); a.click(); }
  static async import(file){ const txt=await file.text(); const obj=JSON.parse(txt); localStorage.setItem(this.key, JSON.stringify(obj)); Util.toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†'); }
}

/***********************
 *  ã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ+å®¿æ•µï¼‰
 ***********************/
class EventEngine{
  constructor(app){ this.app=app; this.turn=0; this.counts={Combat:0,Social:0,Explore:0}; }
  reset(){ this.turn=0; this.counts={Combat:0,Social:0,Explore:0}; }
  successChance(enc){ const st=this.app.stats.get(enc.stat); const base=enc.base; const ch=this.app.chosenCheat?.effect||{}; const vow=this.app.vow?0.03:0; const fd=this.app.fd * -0.03; const stat=(st-50)*0.004; let p=base + (enc.type==='Social'?(ch.social||0):0) + (enc.type==='Combat'?(ch.combat||0):0) + (enc.type==='Explore'?(ch.craft||0):0) + vow + fd + stat; if(this.app.mode==='Daily'){ p = base + fd + stat + (ch.reveal?0:0); } return Util.clamp(p,0.2,0.9); }
  drawEncounter(){ const typeOrder=['Combat','Social','Explore']; const t=typeOrder[this.turn%3]; const list=this.app.pack.active.encounters.filter(e=>e.type===t); const rng=new RNG(this.app.seed + this.turn*1337 + this.app.fd*17); return list[rng.range(0,list.length-1)]; }
  maybeNemesis(){ if(this.app.fd<2) return null; const rng=new RNG(this.app.seed ^ 0xdeadbeef ^ this.turn); if(!rng.chance(0.5)) return null; return new Encounter({id:'nemesis', type:'Combat', title:'å®¿æ•µã¨ã®é‚‚é€…', stat:'DEX', base:0.46 - 0.03 + this.app.fd* -0.02, reward:12}); }
  next(){ if(this.turn>=3){ // å®¿æ•µåˆ¤å®š
      const n=this.maybeNemesis(); if(n){ this.renderCard(n,true); return; } this.app.finalize(); return; }
    const enc=this.drawEncounter(); this.renderCard(enc,false); }
  resolve(enc, p, mod){ const rng=new RNG(this.app.seed ^ ((this.turn+1)<<5)); const auto=(this.app.chosenCheat?.effect?.autoevade>0 && enc.type==='Combat'); let ok; if(auto){ ok=true; this.app.chosenCheat.effect.autoevade--; } else ok = rng.next() < (p+mod); this.counts[enc.type]++; this.app.codex.encounters.add(enc.id); if(ok){ this.app.legend += enc.reward; Sound.beep(true); } else { this.app.legend += 2; Sound.beep(false); } this.turn++; Util.$('#legendLbl').textContent=this.app.legend; }
  renderCard(enc,isNemesis){ const wrap=Util.$('#encCard'); wrap.innerHTML=''; wrap.appendChild(Util.el('div',{class:'badge',text:(isNemesis?'NEMESIS':'é­é‡')+` / ${enc.type} / è¦æ±‚:${enc.stat}`})); wrap.appendChild(Util.el('h3',{text:enc.title})); const p=this.successChance(enc); if(this.app.chosenCheat?.effect?.reveal){ wrap.appendChild(Util.el('div',{class:'hint',text:`æˆåŠŸç‡ã®äºˆæ„Ÿ: ${(p*100).toFixed(0)}%`})); } const a=Util.el('button',{class:'btn primary',text:'A) æ­£é¢ã‹ã‚‰æŒ‘ã‚€',onclick:()=>{this.resolve(enc,p,+0.00);}}); const b=Util.el('button',{class:'btn',text:'B) æ§˜å­ã‚’ã†ã‹ãŒã†',onclick:()=>{this.resolve(enc,Util.clamp(p+0.05,0,1),-0.02);}}); wrap.appendChild(Util.el('div',{class:'row',style:'margin-top:8px'},[a,b])); }
}

/***********************
 *  ã‚µãƒãƒªãƒ¼æç”»
 ***********************/
class Summary{
  static draw(app){ const c=Util.$('#summaryCvs'), g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height); g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim(); g.fillRect(0,0,c.width,c.height); // header
    g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#88e0ff'; g.font='700 28px system-ui, sans-serif'; g.fillText('Isekai Foundry', 24, 42); g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#9ab0c9'; g.font='14px system-ui, sans-serif'; g.fillText(`Seed ${app.seed} â€¢ Legend ${app.legend}`, 24, 66);
    // avatar snapshot
    const rng=new RNG(app.seed^12345); const skin=`hsl(${rng.range(20,40)},30%,${rng.range(55,70)}%)`; const hair=`hsl(${rng.range(0,360)},45%,${rng.range(25,40)}%)`; const eye=`hsl(${rng.range(180,260)},70%,${rng.range(45,60)}%)`; g.fillStyle='rgba(0,0,0,.15)'; g.fillRect(24,86,200,200); g.fillStyle=skin; g.beginPath(); g.arc(124,186,76,0,Math.PI*2); g.fill(); g.fillStyle=hair; g.beginPath(); g.ellipse(124,154,88,56,0,0,Math.PI*2); g.fill(); g.fillStyle=eye; g.beginPath(); g.arc(96,186,12,0,Math.PI*2); g.fill(); g.beginPath(); g.arc(152,186,12,0,Math.PI*2); g.fill();
    // world & stats
    g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#cfe2ff'; g.font='600 16px system-ui, sans-serif'; g.fillText(app.world.name, 248, 110); g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#9ab0c9'; g.fillText(app.world.tags.join(' / '), 248, 132); g.fillText('Start: '+app.world.spot, 248, 152); let y=190; for(const [k,v] of Object.entries(app.stats.map)){ g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#9ab0c9'; g.fillText(k,248,y); g.strokeStyle='#21324b'; g.lineWidth=10; g.beginPath(); g.moveTo(300,y-6); g.lineTo(540,y-6); g.stroke(); g.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#88e0ff'; g.lineWidth=10; g.beginPath(); g.moveTo(300,y-6); g.lineTo(300+Util.clamp(v,0,120)*2,y-6); g.stroke(); y+=28; }
    g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#cfe2ff'; g.fillText('Cheat: '+(app.chosenCheat?.name||'-'), 24, 320); g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#9ab0c9'; g.fillText('Vow: '+(app.vow?.name||'-')+` / FD ${app.fd}`, 24, 342); const titles=app.pack.active.titles.filter(t=>app.codex.titles.has(t.id)).map(t=>t.name); g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#cfe2ff'; g.fillText('Legend '+app.legend,24,372); g.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim()||'#9ab0c9'; g.fillText('Titles: '+(titles.join('ã€')||'â€”'),24,394); g.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--line').trim()||'#1b2330'; g.strokeRect(12,12,576,776); }
}

/***********************
 *  ãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆã‚¿ãƒ–ï¼‰
 ***********************/
class Router{
  static set(name){ Util.$$('.tabbtn').forEach(b=>b.setAttribute('aria-selected', b.dataset.tab===name?'true':'false')); Util.$$('.section').forEach(sec=>sec.classList.remove('active')); Util.$(`#sec-${name}`).classList.add('active'); }
}

/***********************
 *  ã‚¢ãƒ—ãƒªæœ¬ä½“
 ***********************/
class App{
  constructor(){ this.qs=new URLSearchParams(location.search); this.mode='Casual'; this.seed=null; this.profile=null; this.stats=null; this.world=null; this.cheatChoices=[]; this.chosenCheat=null; this.vow=null; this.fd=0; this.legend=0; this.vowKept=0; this.codex={ blessings:new Set(), titles:new Set(), encounters:new Set() }; this.pack=new PackManager(); this.engine=new EventEngine(this); }
  initUI(){ // tab nav
    Util.$$('.tabbtn').forEach(b=>b.addEventListener('click',()=>Router.set(b.dataset.tab)));
    // buttons
    Util.$('#btnRand').onclick=()=>Profile.randomizeToInputs();
    Util.$('#btnMake').onclick=()=>this.startBestowal();
    Util.$('#btnLockIn').onclick=()=>this.lockIn();
    Util.$('#btnNextTurn').onclick=()=>this.engine.next();
    Util.$('#btnCopy').onclick=()=>this.copyURL();
    Util.$('#btnSavePng').onclick=()=>this.savePNG();
    Util.$('#btnReplay').onclick=()=>Router.set('input');
    Util.$('#btnWebShare').onclick=()=>this.webShare();
    Util.$('#btnApplyPack').onclick=()=>this.applyPackFromTextarea();
    Util.$('#btnLoadExample').onclick=()=>this.loadPackExample();
    Util.$('#btnCasual').onclick=()=>this.applyMode('Casual');
    Util.$('#btnDaily').onclick=()=>this.applyMode('Daily');
    Util.$('#btnReset').onclick=()=>{Save.reset(); Util.toast('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»');};
    Util.$('#btnTheme').onclick=()=>Theme.toggle();
    Util.$('#btnSound').onclick=()=>Sound.toggle();
    Util.$('#btnExport').onclick=()=>Save.export();
    Util.$('#fileImport').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) Save.import(f).then(()=>location.reload()); });
    Util.$('#btnRegisterSW').onclick=()=>this.registerSW();
  }
  async init(){ Theme.load(); const s=Save.load(); if(s){ this.codex.blessings=s.codex.blessings; this.codex.titles=s.codex.titles; this.codex.encounters=s.codex.encounters; }
    // mode by seed param
    const seedParam=this.qs.get('seed'); if(seedParam && /^\d{8}$/.test(seedParam)) this.applyMode('Daily'); else this.applyMode('Casual');
    // packUrl
    const packUrl=this.qs.get('packUrl'); if(packUrl){ try{ await this.pack.loadFromUrl(packUrl); }catch(e){ Util.toast('Packèª­è¾¼å¤±æ•—: '+e.message); } }
    this.renderCodex(); }
  applyMode(mode){ this.mode=mode; Util.$('#modeLbl').textContent=mode; if(mode==='Daily') this.seed=parseInt(this.qs.get('seed')||Util.todaySeed(),10); Util.$('#seedLbl').textContent=this.seed||'-'; }
  startBestowal(){ this.profile=Profile.fromInputs(); let seed=parseInt(this.qs.get('seed')||'',10); if(this.mode==='Daily'){ seed = parseInt(this.qs.get('seed')||Util.todaySeed(),10); } if(!seed||isNaN(seed)) seed=this.profile.seed(); this.seed=seed; Util.$('#seedLbl').textContent=this.seed; // build
    this.stats=Stats.generate(seed); this.world=World.build(seed,this.pack.active); this.legend=0; this.fd=0; this.chosenCheat=null; this.vow=null; this.cheatChoices=[...this.pack.active.cheats].sort(()=>Math.random()-.5).slice(0,3); // ui
    this.updateBestowUI(); Router.set('bestow'); Save.save(this); }
  updateBestowUI(){ Util.$('#worldName').textContent=this.world.name; Util.$('#worldTags').textContent=this.world.tags.join(' / '); Util.$('#startSpot').textContent='é–‹å§‹åœ°ï¼š'+this.world.spot; const tbody=Util.$('#statTbody'); tbody.innerHTML=''; for(const [k,v] of Object.entries(this.stats.map)){ tbody.appendChild(Util.el('tr',{},[Util.el('th',{text:k}), Util.el('td',{html:`<div class="statbar"><i style="width:${Util.clamp(v,0,120)/1.2}%"></i></div>`}), Util.el('td',{text:v})])); } Avatar.render(Util.$('#avatar'), this.seed); const list=Util.$('#cheatList'); list.innerHTML=''; this.cheatChoices.forEach(ch=>{ const rareClass = ch.rank==='S'?'rS':(ch.rank==='A'?'rA':'rB'); const c=Util.el('div',{class:'card'},[ Util.el('div',{class:'rarity '+rareClass, text:`${ch.rank} / ${ch.name}`}), Util.el('div',{class:'hint', text:ch.desc}), Util.el('div',{class:'hint', text:`FD +${ch.fd}`}) ]); c.appendChild(Util.el('div',{style:'margin-top:6px'},[ Util.el('button',{class:'btn',text:'ã“ã‚Œã«ã™ã‚‹',onclick:()=>this.chooseCheat(ch)}) ])); list.appendChild(c); }); }
  chooseCheat(ch){ this.chosenCheat=ch; this.fd=ch.fd|0; Router.set('choose'); this.renderChoose(); }
  renderChoose(){ const wrap=Util.$('#chosenCheat'); wrap.innerHTML=''; if(!this.chosenCheat){ wrap.appendChild(Util.el('div',{class:'hint',text:'ãƒãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'})); return; } wrap.appendChild(Util.el('span',{class:'badge',text:`é¸æŠ: ${this.chosenCheat.name} / FD ${this.chosenCheat.fd}`})); const vows=[ new Vow({id:'v_truth',name:'å˜˜ã‚’ã¤ã‹ãªã„',mod:{vow:-1}}), new Vow({id:'v_help',name:'å¼±è€…ã‚’è¦‹æ¨ã¦ãªã„',mod:{vow:-1}}), new Vow({id:'v_noforb',name:'ç¦å‘ªã‚’ä½¿ã‚ãªã„',mod:{vow:-1}}) ]; const box=Util.$('#vowList'); box.innerHTML=''; vows.forEach(v=>{ const b=Util.el('button',{class:'btn ghost',text:v.name,onclick:()=>{ this.vow=v; Util.$('#btnLockIn').disabled=false; Util.$$('#vowList .btn').forEach(x=>x.classList.remove('ok')); b.classList.add('ok'); }}); box.appendChild(b); }); }
  lockIn(){ if(!this.vow) return; this.fd=Math.max(0,(this.fd|0)-1); if(this.chosenCheat) this.codex.blessings.add(this.chosenCheat.id); Router.set('prologue'); this.startPrologue(); }
  startPrologue(){ Util.$('#goddessLine').textContent='å¥³ç¥ï¼šã€Œ'+ this.pickGoddessLine() +'ã€'; this.engine.reset(); this.engine.next(); }
  pickGoddessLine(){ const lines=this.pack.active.goddessLines||['â€¦â€¦ã‚ˆã†ã“ã']; const rng=new RNG(this.seed^0x9e3779b9); return lines[rng.range(0,lines.length-1)]; }
  finalize(){ // titles
    const ctx={legend:this.legend, vowKept:this.vowKept, fd:this.fd, events:this.engine.counts}; const gained=this.pack.active.titles.filter(t=>t.cond(ctx)); gained.forEach(t=>this.codex.titles.add(t.id)); // share url
    const url=new URL(location.href); url.searchParams.set('seed',String(this.mode==='Daily'? (this.qs.get('seed')||Util.todaySeed()) : this.seed)); Util.$('#shareUrl').value=url.toString(); // result text
    Util.$('#resultText').innerHTML=`<div class="row"><span class="badge">ä¸–ç•Œ: ${this.world.name}</span><span class="badge">é–‹å§‹åœ°: ${this.world.spot}</span></div>
      <div style="margin-top:6px">ãƒãƒ¼ãƒˆ: <b>${this.chosenCheat?.name||'-'}</b> / èª“ç´„: <b>${this.vow?.name||'-'}</b> / FD: <b>${this.fd}</b></div>
      <div>Legend: <b>${this.legend}</b> / ç§°å·: <b>${gained.map(t=>t.name).join('ã€')||'â€”'}</b></div>`; Summary.draw(this); Router.set('result'); Save.save(this); this.renderCodex(); }
  copyURL(){ navigator.clipboard.writeText(Util.$('#shareUrl').value).then(()=>Util.toast('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(()=>Util.toast('ã‚³ãƒ”ãƒ¼å¤±æ•—')) }
  savePNG(){ const a=document.createElement('a'); a.download='Isekai_Summary.png'; a.href=Util.$('#summaryCvs').toDataURL('image/png'); a.click(); }
  webShare(){ if(navigator.share){ navigator.share({title:'Isekai Foundry', text:`Legend ${this.legend} / ${this.world.name}`, url:Util.$('#shareUrl').value}).catch(()=>{}); } else { this.copyURL(); } }
  renderCodex(){ const totalBless=this.pack.active.cheats.length; const totalTitles=this.pack.active.titles.length; const totalEnc=this.pack.active.encounters.length; Util.$('#codBless').textContent=`${this.codex.blessings.size}/${totalBless}`; Util.$('#codTitles').textContent=`${this.codex.titles.size}/${totalTitles}`; Util.$('#codEncounter').textContent=`${this.codex.encounters.size}/${totalEnc}`; const totalPct=Math.round(((this.codex.blessings.size/totalBless)+(this.codex.titles.size/totalTitles)+(this.codex.encounters.size/totalEnc))/3*100); Util.$('#codTotal').textContent=`${isFinite(totalPct)?totalPct:0}%`; const list=Util.$('#codexList'); list.innerHTML=''; this.pack.active.cheats.forEach(ch=>{ const owned=this.codex.blessings.has(ch.id); list.appendChild(Util.el('div',{class:'card'},[ Util.el('div',{class:'rarity '+(ch.rank==='S'?'rS':ch.rank==='A'?'rA':'rB'),text:`${ch.rank} ${ch.name}`}), Util.el('div',{class:'hint',text:ch.desc}), Util.el('div',{class:'hint',text:owned?'ç²å¾—æ¸ˆã¿':'æœªç²å¾—'}) ])); }); const chapters=[ {need:25,title:'æœ€åˆã®éˆ´',text:'ã‚¬ãƒãƒ£æ©Ÿã®å¥¥ã§ã€å…‰ã‚‹æ­¯è»ŠãŒå°ã•ãé³´ã£ãŸã€‚'}, {need:50,title:'è’é›†è€…ã®ç´„æŸ',text:'é›†ã‚ã‚‹ã“ã¨ã¯çµ‚ã‚ã‚Šã˜ã‚ƒãªã„ã€‚å…‰ã¯æ¼”å‡ºã¨ãªã£ã¦æ®‹ã‚‹ã€‚'}, {need:75,title:'æ¬ ç‰‡ã®åœ°å›³',text:'æœªæ‰€æŒã®ç©ºç™½ãŒã€æ¬¡ã®é“ã‚’æŒ‡ã—ã¦ã„ã‚‹ã€‚'}, {need:100,title:'å›³é‘‘ã®å‘ã“ã†',text:'ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã¯åˆå›³ã€‚å›ã®æ¼”å‡ºã¯èª°ã‹ã®æŒ‘æˆ¦ã‚’ç…§ã‚‰ã™ã€‚'} ]; const pct=parseInt(Util.$('#codTotal').textContent)||0; const sl=Util.$('#storyList'); sl.innerHTML=''; chapters.forEach(ch=>{ const unlocked=pct>=ch.need; sl.appendChild(Util.el('div',{class:'card'},[ Util.el('div',{class:'row'},[Util.el('span',{class:'badge',text:`${ch.need}%`}), Util.el('b',{text:ch.title})]), Util.el('div',{class:'hint',text: unlocked? ch.text : 'æœªè§£æ”¾'}) ])); }); }
  applyPackFromTextarea(){ try{ const txt=Util.$('#packJson').value.trim(); if(!txt) return; const obj=JSON.parse(txt); this.pack.apply(obj); }catch(e){ Util.toast('JSONã‚¨ãƒ©ãƒ¼: '+e.message); } }
  loadPackExample(){ const example={ packId:'oceanic-v1', title:'Oceanic Archipelago', worldTags:['archipelago','coral','storm'], startSpots:['æ¸¯ç”ºã‚µãƒ¼ã‚¸','ç¯å°ã‚±ãƒ«ãƒ³','æ½®é¨’ã®æµœ'], goddessLines:['æ½®ãŒæº€ã¡ã€å›ã®åã‚’å‘¼ã¶ã€‚','æ³¢é–“ã®å…‰ãŒé“ã¨ãªã‚‹ã€‚'], cheats:[ {id:'tide-vision',rank:'A',name:'æ½®ã®å…ˆèª­ã¿',fd:2,desc:'æµ·ç³»ã‚¤ãƒ™ãƒ³ãƒˆæˆåŠŸ+12%',effect:{craft:+0.12}}, {id:'whale-tongue',rank:'B',name:'é¯¨ã®è¨€éœŠ',fd:1,desc:'æ°´ä¸Šäº¤æ¸‰+10%',effect:{social:+0.10}}, {id:'storm-leap',rank:'S',name:'åµæ¸¡ã‚Š',fd:3,desc:'ä¸€åº¦ã ã‘è‡´å‘½å¤±æ•—ã‚’å›é¿',effect:{autoevade:1}} ], encounters:[ {id:'e007',type:'Explore',title:'æ½®ã®æ´çªŸ',stat:'INT',base:0.55,reward:8}, {id:'e008',type:'Combat',title:'æµ·è³Šã¨ã®é”è¿«ã‚Šåˆã„',stat:'DEX',base:0.5,reward:9}, {id:'e009',type:'Social',title:'æ¸¯ã®å€¤åˆ‡ã‚Šäº¤æ¸‰',stat:'CHA',base:0.52,reward:7} ], titles:[ {id:'t_sea_star',name:'æµ·ã®æ˜Ÿ',cond:(ctx)=>ctx.legend>=14} ] }; Util.$('#packJson').value=JSON.stringify(example,null,2); Util.toast('ä¾‹ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ'); }
  async registerSW(){ if(!('serviceWorker' in navigator)){ Util.toast('SWæœªå¯¾å¿œ'); return; } const swCode=`self.addEventListener('install',e=>{e.waitUntil(caches.open('ifoundry-v1').then(c=>c.addAll(['./'])))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`; const blob=new Blob([swCode],{type:'text/javascript'}); const url=URL.createObjectURL(blob); try{ const reg=await navigator.serviceWorker.register(url); Util.toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã‚’ç™»éŒ²ã—ã¾ã—ãŸ'); }catch(e){ Util.toast('PWAç™»éŒ²å¤±æ•—: '+e.message); }
  }
}

/***********************
 *  èµ·å‹•
 ***********************/
const app=new App();
app.initUI();
app.init();
</script>
</body>
</html>
